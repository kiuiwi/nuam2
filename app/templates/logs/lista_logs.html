<h2>Eventos del sistema</h2>

<style>
    .log-row {
        font-size: 18px;
    }
    .color-login { color: gray; font-weight: bold; }
    .color-usuario { color: orange; font-weight: bold; }
    .color-documento { color: blue; font-weight: bold; }
</style>

<table id="logsTable" border="1" cellpadding="8">
    <tr>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Mensaje</th>
    </tr>

    {% for log in logs %}
    <tr class="log-row">
        <td>{{ log.fecha|date:"d/m/Y H:i:s" }}</td>
        <td class="
            {% if log.tipo == 'Login' %}color-login{% elif log.tipo == 'Usuario' %}color-usuario{% elif log.tipo == 'Documento' %}color-documento{% else %}color-login{% endif %}
        ">
            {% comment %} El icono se decide por mensaje {% endcomment %}
            {% if 'creado' in log.mensaje|lower or 'inicio' in log.mensaje|lower %}
                ðŸŸ¢
            {% elif 'editado' in log.mensaje|lower %}
                ðŸŸ 
            {% elif 'eliminado' in log.mensaje|lower or 'fallido' in log.mensaje|lower %}
                ðŸ”´
            {% else %}
                âšª
            {% endif %}
            {{ log.tipo }}
        </td>
        <td>{{ log.mensaje }}</td>
    </tr>
    {% endfor %}
</table>

<script>
function formatDate(dateString) {
    return new Date(dateString).toLocaleString("es-CL", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
    });
}

function cargarLogs() {
    fetch("/api/logs/")
        .then(res => res.json())
        .then(data => {
            const table = document.getElementById("logsTable");

            let html = `
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Mensaje</th>
                </tr>
            `;

            data.forEach(log => {
                let colorClass = "color-login"; // letra
                switch(log.tipo) {
                    case "Login": colorClass = "color-login"; break;
                    case "Usuario": colorClass = "color-usuario"; break;
                    case "Documento": colorClass = "color-documento"; break;
                }

                // Icono segÃºn acciÃ³n detectada en el mensaje
                const msg = log.mensaje.toLowerCase();
                let icon = "âšª"; 
                if (msg.includes("creado") || msg.includes("inicio")) icon = "ðŸŸ¢";
                else if (msg.includes("editado")) icon = "ðŸŸ ";
                else if (msg.includes("eliminado") || msg.includes("fallido")) icon = "ðŸ”´";

                html += `
                    <tr class="log-row">
                        <td>${formatDate(log.fecha)}</td>
                        <td class="${colorClass}">${icon} ${log.tipo}</td>
                        <td>${log.mensaje}</td>
                    </tr>
                `;
            });

            table.innerHTML = html;
        })
        .catch(err => console.error("Error al cargar logs:", err));
}

// Refrescar cada 3 segundos
setInterval(cargarLogs, 3000);

// Cargar al abrir la pÃ¡gina
cargarLogs();
</script>
